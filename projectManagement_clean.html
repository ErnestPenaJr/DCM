<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Management - Clean Version</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .modal-content {
            color: #000 !important;
        }
        .modal-body {
            color: #000 !important;
        }
        .modal-title {
            color: #000 !important;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4 class="mb-0"><i class="fas fa-project-diagram me-2"></i>Project Management - Clean Version</h4>
                        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addProjectModal">
                            <i class="fas fa-plus me-2"></i>Add New Project
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- Alert Container -->
                        <div id="alertContainer" style="display: none;">
                            <div id="alertMessage" class="alert alert-dismissible fade show" role="alert">
                                <span id="alertText"></span>
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        </div>

                        <!-- Simple Table -->
                        <div class="table-responsive">
                            <table id="projectsTable" class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>ID</th>
                                        <th>Project Name</th>
                                        <th>Description</th>
                                        <th>Status</th>
                                        <th>Created Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Projects will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Project Modal -->
    <div class="modal fade" id="addProjectModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">Add New Project</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addProjectForm" novalidate>
                        <div class="mb-3">
                            <label for="projectName" class="form-label">Project Name *</label>
                            <input type="text" class="form-control" id="projectName" required maxlength="225">
                        </div>
                        <div class="mb-3">
                            <label for="projectDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="projectDescription" rows="3" maxlength="500"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="projectStatus" class="form-label">Status *</label>
                            <select class="form-select" id="projectStatus" required>
                                <option value="A">Active</option>
                                <option value="I">Inactive</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="saveProjectBtn">
                        <i class="fas fa-save me-2"></i>Save Project
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Project Modal -->
    <div class="modal fade" id="editProjectModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title">Edit Project</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editProjectForm" novalidate>
                        <input type="hidden" id="editProjectId">
                        <div class="mb-3">
                            <label for="editProjectName" class="form-label">Project Name *</label>
                            <input type="text" class="form-control" id="editProjectName" required maxlength="225">
                        </div>
                        <div class="mb-3">
                            <label for="editProjectDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="editProjectDescription" rows="3" maxlength="500"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="editProjectStatus" class="form-label">Status *</label>
                            <select class="form-select" id="editProjectStatus" required>
                                <option value="A">Active</option>
                                <option value="I">Inactive</option>
                            </select>
                        </div>
                        <div id="editUsageWarning" class="alert alert-info" style="display: none;">
                            <i class="fas fa-info-circle me-2"></i>
                            This project has <span id="editTaskCount"></span> associated tasks.
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" id="updateProjectBtn">
                        <i class="fas fa-save me-2"></i>Update Project
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteProjectModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Delete Project</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="deleteProjectId">
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Warning!</strong> This action cannot be undone.
                    </div>
                    <p>Are you sure you want to delete the project "<strong id="deleteProjectName"></strong>"?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                        <i class="fas fa-trash me-2"></i>Delete Project
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Set up session storage for testing
        sessionStorage.setItem('ISLOGGINEDIN', 'true');
        sessionStorage.setItem('EMPLID', '132034');

        $(document).ready(function() {
            console.log('🚀 Page loaded - Clean version');
            setupFormHandlers();
            loadProjects();
        });

        function setupFormHandlers() {
            // Add project form submission
            $('#saveProjectBtn').on('click', function(e) {
                e.preventDefault();
                var form = $('#addProjectForm')[0];
                
                if (form.checkValidity()) {
                    saveNewProject();
                } else {
                    form.classList.add('was-validated');
                }
            });

            // Reset form when modal is hidden
            $('#addProjectModal').on('hidden.bs.modal', function() {
                $('#addProjectForm')[0].reset();
                $('#addProjectForm').removeClass('was-validated');
            });

            // Edit project form submission
            $('#updateProjectBtn').on('click', function(e) {
                e.preventDefault();
                var form = $('#editProjectForm')[0];
                
                if (form.checkValidity()) {
                    updateProject();
                } else {
                    form.classList.add('was-validated');
                }
            });

            // Reset edit form when modal is hidden
            $('#editProjectModal').on('hidden.bs.modal', function() {
                $('#editProjectForm')[0].reset();
                $('#editProjectForm').removeClass('was-validated');
                $('#editUsageWarning').hide();
            });

            // Delete project confirmation
            $('#confirmDeleteBtn').on('click', function(e) {
                e.preventDefault();
                deleteProject();
            });
        }

        function loadProjects() {
            console.log('🔄 Loading projects...');
            showAlert('Loading projects...', 'info');

            $.ajax({
                type: "POST",
                url: "assets/CFCs/functions.cfc",
                dataType: "json",
                data: {
                    method: "getAllProjects"
                },
                success: function(response) {
                    console.log('✅ Projects loaded:', response);
                    var tbody = $('#projectsTable tbody');
                    tbody.empty();
                    
                    if (response.items && response.items.length > 0) {
                        response.items.forEach(function(project) {
                            var statusBadge = project.STATUS === 'A' ? 
                                '<span class="badge bg-success">Active</span>' : 
                                '<span class="badge bg-secondary">Inactive</span>';
                            
                            var statusButton = project.STATUS === 'A' ? 
                                '<button class="btn btn-sm btn-outline-warning me-1" onclick="toggleProjectStatus(' + project.PROJECT_ID + ', \'A\')" title="Deactivate"><i class="fas fa-pause"></i></button>' :
                                '<button class="btn btn-sm btn-outline-success me-1" onclick="toggleProjectStatus(' + project.PROJECT_ID + ', \'I\')" title="Activate"><i class="fas fa-play"></i></button>';
                            
                            var actions = '<button class="btn btn-sm btn-outline-primary me-1" onclick="editProject(' + project.PROJECT_ID + ')" title="Edit"><i class="fas fa-edit"></i></button>' +
                                        statusButton +
                                        '<button class="btn btn-sm btn-outline-danger" onclick="confirmDeleteProject(' + project.PROJECT_ID + ', \'' + project.PROJECT_NAME.replace(/'/g, "\\'") + '\')" title="Delete"><i class="fas fa-trash"></i></button>';
                            
                            var row = '<tr>' +
                                '<td>' + project.PROJECT_ID + '</td>' +
                                '<td>' + project.PROJECT_NAME + '</td>' +
                                '<td>' + project.PROJECT_DESCRIPTION + '</td>' +
                                '<td>' + statusBadge + '</td>' +
                                '<td>' + project.DATECREATED + '</td>' +
                                '<td>' + actions + '</td>' +
                                '</tr>';
                            
                            tbody.append(row);
                        });
                        showAlert('Projects loaded successfully (' + response.items.length + ' found)', 'success');
                    } else {
                        tbody.append('<tr><td colspan="6" class="text-center">No projects found</td></tr>');
                        showAlert('No projects found', 'info');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('❌ Error loading projects:', error);
                    showAlert('Error loading projects: ' + error, 'danger');
                }
            });
        }

        function saveNewProject() {
            var formData = {
                projectName: $('#projectName').val(),
                projectDescription: $('#projectDescription').val(),
                projectStatus: $('#projectStatus').val()
            };

            $('#saveProjectBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Saving...');

            $.ajax({
                type: "POST",
                url: "assets/CFCs/functions.cfc",
                dataType: "json",
                data: {
                    method: "createProject",
                    PROJECT_NAME: formData.projectName,
                    PROJECT_DESCRIPTION: formData.projectDescription,
                    STATUS: formData.projectStatus
                },
                success: function(response) {
                    console.log('Create response:', response);
                    if (response.success) {
                        $('#addProjectModal').modal('hide');
                        showAlert('Project "' + formData.projectName + '" created successfully!', 'success');
                        loadProjects();
                    } else {
                        showAlert('Error creating project: ' + (response.message || 'Unknown error'), 'danger');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('AJAX Error:', xhr.responseText);
                    showAlert('Error creating project: ' + error, 'danger');
                },
                complete: function() {
                    $('#saveProjectBtn').prop('disabled', false).html('<i class="fas fa-save me-2"></i>Save Project');
                }
            });
        }

        function editProject(projectId) {
            console.log('🔧 Editing project ID:', projectId);
            showAlert('Loading project details...', 'info');
            
            $.ajax({
                type: "POST",
                url: "assets/CFCs/functions.cfc",
                dataType: "json",
                data: {
                    method: "getProjectById",
                    PROJECT_ID: projectId
                },
                success: function(response) {
                    console.log('📥 Project details:', response);
                    
                    if (response && response.PROJECT_ID) {
                        $('#editProjectId').val(response.PROJECT_ID);
                        $('#editProjectName').val(response.PROJECT_NAME);
                        $('#editProjectDescription').val(response.PROJECT_DESCRIPTION);
                        $('#editProjectStatus').val(response.STATUS);
                        
                        if (response.TASK_COUNT && response.TASK_COUNT > 0) {
                            $('#editTaskCount').text(response.TASK_COUNT);
                            $('#editUsageWarning').show();
                        } else {
                            $('#editUsageWarning').hide();
                        }
                        
                        $('#editProjectModal').modal('show');
                        showAlert('Edit modal opened', 'success');
                    } else {
                        showAlert('Project not found', 'danger');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('❌ Error getting project details:', error);
                    showAlert('Error loading project details: ' + error, 'danger');
                }
            });
        }

        function updateProject() {
            var projectId = $('#editProjectId').val();
            var formData = {
                projectName: $('#editProjectName').val(),
                projectDescription: $('#editProjectDescription').val(),
                projectStatus: $('#editProjectStatus').val()
            };

            $('#updateProjectBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Updating...');

            $.ajax({
                type: "POST",
                url: "assets/CFCs/functions.cfc",
                dataType: "json",
                data: {
                    method: "updateProject",
                    PROJECT_ID: projectId,
                    PROJECT_NAME: formData.projectName,
                    PROJECT_DESCRIPTION: formData.projectDescription,
                    STATUS: formData.projectStatus
                },
                success: function(response) {
                    console.log('✅ Update response:', response);
                    if (response.success) {
                        $('#editProjectModal').modal('hide');
                        showAlert('Project updated successfully!', 'success');
                        loadProjects();
                    } else {
                        showAlert('Error updating project: ' + (response.message || 'Unknown error'), 'danger');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('❌ Update error:', error);
                    showAlert('Error updating project: ' + error, 'danger');
                },
                complete: function() {
                    $('#updateProjectBtn').prop('disabled', false).html('<i class="fas fa-save me-2"></i>Update Project');
                }
            });
        }

        function toggleProjectStatus(projectId, currentStatus) {
            var newStatus = currentStatus === 'A' ? 'I' : 'A';
            var statusText = newStatus === 'A' ? 'activated' : 'deactivated';
            
            $.ajax({
                type: "POST",
                url: "assets/CFCs/functions.cfc",
                dataType: "json",
                data: {
                    method: "toggleProjectStatus",
                    PROJECT_ID: projectId,
                    NEW_STATUS: newStatus
                },
                success: function(response) {
                    if (response.success) {
                        showAlert('Project ' + statusText + ' successfully!', 'success');
                        loadProjects();
                    } else {
                        showAlert('Error updating project status', 'danger');
                    }
                },
                error: function(xhr, status, error) {
                    showAlert('Error updating project status: ' + error, 'danger');
                }
            });
        }

        function confirmDeleteProject(projectId, projectName) {
            $('#deleteProjectId').val(projectId);
            $('#deleteProjectName').text(projectName);
            $('#deleteProjectModal').modal('show');
        }

        function deleteProject() {
            var projectId = $('#deleteProjectId').val();
            var projectName = $('#deleteProjectName').text();

            $('#confirmDeleteBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Deleting...');

            $.ajax({
                type: "POST",
                url: "assets/CFCs/functions.cfc",
                dataType: "json",
                data: {
                    method: "deleteProject",
                    PROJECT_ID: projectId
                },
                success: function(response) {
                    if (response.success) {
                        $('#deleteProjectModal').modal('hide');
                        showAlert('Project deleted successfully!', 'success');
                        loadProjects();
                    } else {
                        showAlert('Error deleting project', 'danger');
                    }
                },
                error: function(xhr, status, error) {
                    showAlert('Error deleting project: ' + error, 'danger');
                },
                complete: function() {
                    $('#confirmDeleteBtn').prop('disabled', false).html('<i class="fas fa-trash me-2"></i>Delete Project');
                }
            });
        }

        function showAlert(message, type) {
            var alertClass = 'alert-' + type;
            var iconClass = type === 'success' ? 'fa-check-circle' : 
                           type === 'danger' ? 'fa-exclamation-circle' : 
                           'fa-info-circle';

            $('#alertMessage').removeClass().addClass('alert alert-dismissible fade show ' + alertClass);
            $('#alertText').html('<i class="fas ' + iconClass + ' me-2"></i>' + message);
            $('#alertContainer').slideDown();

            setTimeout(function() {
                $('#alertContainer').slideUp();
            }, 5000);
        }
    </script>
</body>
</html>
